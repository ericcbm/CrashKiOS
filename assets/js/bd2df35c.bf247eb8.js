"use strict";(self.webpackChunktouchlab=self.webpackChunktouchlab||[]).push([[928],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),h=c(n),u=o,m=h["".concat(l,".").concat(u)]||h[u]||p[u]||r;return n?a.createElement(m,s(s({ref:t},d),{},{components:n})):a.createElement(m,s({ref:t},d))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,s=new Array(r);s[0]=h;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var c=2;c<r;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},2021:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var a=n(7462),o=(n(7294),n(3905));const r={id:"crashlytics"},s="Crashlytics",i={unversionedId:"crashlytics",id:"crashlytics",title:"Crashlytics",description:"If you use Crashlytics and an uncaught exception gets thrown from shared Kotlin code running on iOS, the crash report generated",source:"@site/docs/CrashlyticsTutorial.md",sourceDirName:".",slug:"/crashlytics",permalink:"/docs/crashlytics",draft:!1,editUrl:"https://github.com/touchlab/CrashKiOS/tree/main/website/docs/CrashlyticsTutorial.md",tags:[],version:"current",lastUpdatedBy:"Kevin Galligan",lastUpdatedAt:1695408269,formattedLastUpdatedAt:"Sep 22, 2023",frontMatter:{id:"crashlytics"},sidebar:"tutorialSidebar",previous:{title:"Home",permalink:"/docs/"},next:{title:"Bugsnag",permalink:"/docs/bugsnag"}},l={},c=[{value:"Step 1 - Add Crashlytics to Your Apps",id:"step-1---add-crashlytics-to-your-apps",level:2},{value:"Step 2 - Add CrashKiOS",id:"step-2---add-crashkios",level:2},{value:"Step 3 - Setup Dynamic Linking (Optional)",id:"step-3---setup-dynamic-linking-optional",level:2},{value:"Step 3b - Send dSYMS for Dynamic Framework",id:"step-3b---send-dsyms-for-dynamic-framework",level:2},{value:"Sending Extra Info to Crashlytics",id:"sending-extra-info-to-crashlytics",level:2}],d={toc:c};function p(e){let{components:t,...r}=e;return(0,o.kt)("wrapper",(0,a.Z)({},d,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"crashlytics"},"Crashlytics"),(0,o.kt)("p",null,"If you use Crashlytics and an uncaught exception gets thrown from shared Kotlin code running on iOS, the crash report generated\nwon't be very helpful in determining the cause, see ",(0,o.kt)("a",{parentName:"p",href:"/docs/misc/THE_PROBLEM"},"The Problem")," for more details. CrashKiOS was made\nto remedy this issue and provide meaningful stack traces for Kotlin crashes. "),(0,o.kt)("h2",{id:"step-1---add-crashlytics-to-your-apps"},"Step 1 - Add Crashlytics to Your Apps"),(0,o.kt)("p",null,"First you'll need to set up Crashlytics for your Android and iOS individually. Follow the steps in the ",(0,o.kt)("a",{parentName:"p",href:"https://firebase.google.com/docs/crashlytics/get-started?platform=ios"},"firebase docs"),"\nto set up Crashlytics with your Android app the normal way then do the same for your iOS app. Note, if your repo is\npublic, you probably want to make sure to add Android's ",(0,o.kt)("inlineCode",{parentName:"p"},"google-services.json")," and iOS's ",(0,o.kt)("inlineCode",{parentName:"p"},"GoogleService-info")," files to your\ngitignore.  "),(0,o.kt)("p",null,"Make sure to force a crash on both apps from non-shared code and ensure the crash shows up on the Crashlytics Console.\nIf you're testing a crash on an iOS simulator, you'll need to hit run to build your changes, then close and reopen the app. Otherwise,\nXcode will catch and swallow your crash and it won't get reported. You'll also need to reopen the app after crashing it because\ncrash reports are sent at app startup. You'll also need to make sure you aren't crashing the app at app start which can cause it to\nnot get reported. Make sure the crash is triggered by some action like a button click. Also don't forget to setup automatic\ndSYM uploading so you can see proper stack traces for Swift code."),(0,o.kt)("h2",{id:"step-2---add-crashkios"},"Step 2 - Add CrashKiOS"),(0,o.kt)("p",null,"Once you've verified Crashlyitcs is working for both platforms, you can add the CrashKiOS dependency to ",(0,o.kt)("inlineCode",{parentName:"p"},"commonMain")," in your\nshared module. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'val commonMain by sourceSets.getting {\n    dependencies {\n        implementation("co.touchlab.crashkios:crashlytics:0.8.4")\n    }\n}\n')),(0,o.kt)("p",null,"Then disable caching in your ",(0,o.kt)("inlineCode",{parentName:"p"},"gradle.properties")," file. We're currently working to update things to avoid this, for now\nwe need it to deal with iOS linking issues."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"kotlin.native.cacheKind.iosX64=none\nkotlin.native.cacheKind.iosSimulatorArm64=none\n")),(0,o.kt)("p",null,"After a Gradle sync, make a call to ",(0,o.kt)("inlineCode",{parentName:"p"},"enableCrashlytics()")," somewhere in your startup code for each app. This switches from the\ndefault no-op implementations to real implementations which avoid issues in testing. Depending on how the ",(0,o.kt)("inlineCode",{parentName:"p"},"cacheKind")," issue\nabove is fixed this may no longer be necessary. "),(0,o.kt)("p",null,"Make sure everything works so far by sending a handled exception from shared code and checking that it shows up in your\nCrashlytics dashboard for both platforms."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'CrashlyticsKotlin.sendHandledException(Exception("Some exception"))\n')),(0,o.kt)("p",null,"That's all that's needed to handle uncaught exceptions on Android, but for iOS we need to catch unhandled Kotlin exceptions\nthat come from hard crashes. In startup code for iOS, call ",(0,o.kt)("inlineCode",{parentName:"p"},"setCrashlyticsUnhandledExceptionHook()"),". We usually make a helper\nfunction in ",(0,o.kt)("inlineCode",{parentName:"p"},"iOSMain")," with both setup steps, then call that from iOS app startup: "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},"fun setupCrashlytics() {\n    enableCrashlytics()\n    setCrashlyticsUnhandledExceptionHook()\n}\n")),(0,o.kt)("p",null,"Once this is done, throw an uncaught exception from Kotlin code on iOS. Reminder this needes to happen through user action,\nnot in startup code and you need to relaunch the app after building and after crashing to send the report. The crash should show\nup on the dashboard and should now have Kotlin line numbers "),(0,o.kt)("h2",{id:"step-3---setup-dynamic-linking-optional"},"Step 3 - Setup Dynamic Linking (Optional)"),(0,o.kt)("p",null,"If you're ok with using static frameworks for your shared code, you're done with setup. If you want to export a dynamic framework then you'll see an error like this: "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},'Undefined symbols for architecture x86_64:\n  "_OBJC_CLASS_$_FIRStackFrame", referenced from:\n      objc-class-ref in result.o\n  "_OBJC_CLASS_$_FIRExceptionModel", referenced from:\n      objc-class-ref in result.o\n  "_OBJC_CLASS_$_FIRCrashlytics", referenced from:\n      objc-class-ref in result.o\n  "_FIRCLSExceptionRecordNSException", referenced from:\n      _co_touchlab_crashkios_crashlytics_FIRCLSExceptionRecordNSException_wrapper0 in result.o\nld: symbol(s) not found for architecture x86_64\n')),(0,o.kt)("p",null,"This is because on iOS only the definitions for Crashlytics are added when comiling the Kotlin code and building the framework. The binary (the actual Crashlytics library) isn't added until later when you build the iOS app. When building a dynamic framework, the Kotlin compile expects to be able to resolve everything, so you'll see the above error because Crashlytics isn't there yet. "),(0,o.kt)("p",null,"To workaround this, we need to tell the compiler that these symbols are find and will be there later. Doing it manually is a bit messy so you can just add our gradle plugin to handle it "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'  id("co.touchlab.crashkios.crashlyticslink") version "0.8.4"\n')),(0,o.kt)("h2",{id:"step-3b---send-dsyms-for-dynamic-framework"},"Step 3b - Send dSYMS for Dynamic Framework"),(0,o.kt)("p",null,'If you\'re using a dynamic framework you may also see a warning on the Crashlytics dashboard about missing dSYMS or "Missing UUID" in the stack trace of Kotlin crashes. If that happens adding a build phase to push the Kotlin framework dSYM to Crashlytics separately should resolve it. '),(0,o.kt)("p",null,"In Xcode, select your project on the left sidebar, open the Build Phases Tab, and press the ",(0,o.kt)("inlineCode",{parentName:"p"},"+"),' in the top left. The select\n"New Run Script Phase" and give it a name like "Upload Kotlin dSYM".\nAdd this script to the build phase '),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"Pods/FirebaseCrashlytics/upload-symbols -gsp ios/GoogleService-Info.plist -p ios ../shared/build/cocoapods/framework/shared.framework.dSYM\n")),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"img.png",src:n(9707).Z,width:"2017",height:"538"})),(0,o.kt)("p",null,"You may need to make slight changes to this script to fit your project. In The snippet above we're using ",(0,o.kt)("inlineCode",{parentName:"p"},"shared")," as our\nKotlin module and framework name, and we're exporting to iOS using CocoaPods. Make sure the directory and framework name\nmatches what's in your project by looking in the build folder for your Kotlin module and getting the relative path.\nIf you're not using CocoaPods, you may need to find the dSYMs your project generates and make sure to upload each one\nseparately with the above command. Use this in the shared Kotlin module's directory to get a lis of all of the dSYMs "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'find ./build -name "*.dSYM"\n')),(0,o.kt)("h2",{id:"sending-extra-info-to-crashlytics"},"Sending Extra Info to Crashlytics"),(0,o.kt)("p",null,"CrashKiOS-crashlytics also provides shared code wrappers for sending logs and  custom key values to Crashlytics. When there is a crash, these will show up in the Logs and Keys tabs on the dashboard respectively. "),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-kotlin"},'CrashlyticsKotlin.logMessage("Some message")\nCrashlyticsKotlin.setCustomValue("someKey", "someValue")\n')))}p.isMDXComponent=!0},9707:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/add_build_phase-2b343c9a164899238705af593b4d2f0e.png"}}]);